TRIVA
ThRee dimension-Interactive Visualization Analysis
%%mtime(%d/%m/%Y)

%!target: html
%!options: --css-sugar --mask-email --toc --toc-level=2
%!style: css/modern.css
%!encoding: iso-8859-1

= TRIVA =

TRIVA is a three dimensional interactive visualization analysis tool
that can be used to visualy analyse trace files from computer applications.

== Ubuntu deb Installation (Recommended) ==

+ Required packages
```
$ apt-get install libogre14 libois1 libcegui-mk2-1 libgraphviz3
$ apt-get install libcegui-mk2-dev #Bug 93961 in cegui-mk2 (Ubuntu)
$ apt-get install libffcall1  # for GNUstep
```

+ Installing GNUstep
GNUstep packages in Ubuntu does not work properly (Please, let me know if you
were able to get a nice installation of GNUstep using deb packages in Ubuntu).
Install it using the source, as follows:
```
$ wget http://ftpmain.gnustep.org/pub/gnustep/core/gnustep-startup-0.18.4.tar.gz
$ tar xfz gnustep-startup-0.18.4.tar.gz
$ sudo ./InstallGNUstep
$ source /usr/GNUstep/System/Makefiles/GNUstep.sh
```
In order to uninstall GNUstep, just delete recursively the /usr/GNUstep
directory.

+ Download the following .deb files
The following packages work only when the GNUstep is installed as explained
above.


- [libpaje_0.5 http://www-id.imag.fr/Laboratoire/Membres/Schnorr_Lucas/triva/debs/libpaje_0.5-r17_i386.deb]
- [libgenericevent_0.3 http://www-id.imag.fr/Laboratoire/Membres/Schnorr_Lucas/triva/debs/libgenericevent_0.3-r35_i386.deb]
- [dimvisual_0.7 http://www-id.imag.fr/Laboratoire/Membres/Schnorr_Lucas/triva/debs/dimvisual_0.7-1_i386.deb]
- [dimvisual-kaapi_0.1 http://www-id.imag.fr/Laboratoire/Membres/Schnorr_Lucas/triva/debs/dimvisual-kaapi_0.1-r128_i386.deb]
- [triva_0.1 http://www-id.imag.fr/Laboratoire/Membres/Schnorr_Lucas/triva/debs/triva_0.1-r16_i386.deb]

Install them as follows:

```
$ dpkg -i libpaje_0.5-r17_i386.deb libgenericevent_0.3-r35_i386.deb
$ dpkg -i dimvisual_0.7-1_i386.deb 
$ dpkg -i dimvisual-kaapi_0.1-r128_i386.deb
$ dpkg -i triva_0.1-r16_i386.deb
```


== Source Installation ==

These are instructions to install TRIVA in a deb-like environments, such as
Debian or Ubuntu. The sources of the requirements can also be
found, but specific instructions about their compilation is not provided.
The installation is performed with three steps, as follows.

+ Required packages

The gnustep-startup installs GNUstep the gnustep-base, gnustep-gui, gnustep-make
and gnustep-back. All of them are necessary to TRIVA installation. The
instructions assume that GNUstep will be installed in /usr/GNUstep/.
```
$ apt-get update

$ apt-get install libobjc1 libobjc2 gobjc gobjc++
$ apt-get install libogre-dev libogre14 
$ apt-get install libois-dev libois1
$ apt-get install libcegui-mk2-dev libcegui-mk2-1

$ wget http://ftpmain.gnustep.org/pub/gnustep/core/gnustep-startup-0.18.4.tar.gz
$ tar xfz gnustep-startup-0.18.4.tar.gz
$ sudo ./InstallGNUstep
$ source /usr/GNUstep/System/Makefiles/GNUstep.sh
```

+ DIMVisual installation

The dimvisual-kaapi module assumes KAAPI is installed in /opt/kaapi/. The
default configuration of kaapi module is to group threads by process, showing
them as a single state. The ungrouped view is also available through
--disable-process option to configure command of dimvisual-kaapi module.

```
$ source /usr/GNUstep/System/Makefiles/GNUstep.sh 

$ wget http://www.inf.ufrgs.br/~lmschnorr/downloads/projects/libPaje-0.5.tar.gz
$ tar xfz libPaje-0.5.tar.gz
$ cd libPaje-0.5
$ make install

$ wget http://www.inf.ufrgs.br/~lmschnorr/downloads/projects/libGenericEvent-0.3.tar.gz
$ tar xfz libGenericEvent-0.3.tar.gz
$ cd libGenericEvent-0.3
$ make install

$ wget http://www.inf.ufrgs.br/~lmschnorr/downloads/projects/dimvisual-0.7.tar.gz
$ tar xfz dimvisual-0.7.tar.gz
$ cd dimvisual-0.7
$ ./configure
$ make install

$ wget http://www.inf.ufrgs.br/~lmschnorr/downloads/projects/dimvisual-kaapi-0.1.tar.gz
$ tar xfz dimvisual-kaapi-0.1.tar.gz
$ cd dimvisual-kaapi-0.1
$ export PKG_CONFIG_PATH=/opt/kaapi/lib/pkgconfig/
$ ./configure
$ make install
```

+ TRIVA Installation

```
$ wget http://www-id.imag.fr/Laboratoire/Membres/Schnorr_Lucas/triva/triva-25.tar.gz

$ source /usr/GNUstep/System/Makefiles/GNUstep.sh 
$ tar xfz triva-25.tar.gz
$ cd triva-25
$ ./configure
$ make install
```


== Execution ==

In order to execute the application, a file named **plugins.cfg** must
be present in the same directory where TRIVA will be executed. This is 
an example of this file (customize it to your installation, particulary the
PluginFolder variable):

```
# Define plugin folder (edit here to match your installation)
PluginFolder=/usr/lib/OGRE 

# Define D3D rendering implementation plugin
Plugin=RenderSystem_GL.so
Plugin=Plugin_ParticleFX.so
Plugin=Plugin_BSPSceneManager.so
Plugin=Plugin_OctreeSceneManager.so
#Plugin=Plugin_CgProgramManager.so
```

The following example assumes the **sorted** KAAPI trace files are in the
TRACES/ directory. It also assumes that the file timesync are in the same
directory.

```
$ export LD_LIBRARY_PATH=/opt/kaapi/lib:$LD_LIBRARY_PATH
$ triva -load dimvisual-kaapi.bundle -KAAPI-sync TRACES/timesync \
                                     -KAAPI-file TRACES/sorted*
```


== Downloads ==

- [libPaje 0.5 http://www.inf.ufrgs.br/~lmschnorr/downloads/projects/libPaje-0.5.tar.gz]
- [libGenericEvent 0.3 http://www.inf.ufrgs.br/~lmschnorr/downloads/projects/libGenericEvent-0.3.tar.gz]
- [DIMVisual 0.7 http://www.inf.ufrgs.br/~lmschnorr/downloads/projects/dimvisual-0.7.tar.gz]
- [DIMVisual-KAAPI bundle 0.1 http://www.inf.ufrgs.br/~lmschnorr/downloads/projects/dimvisual-kaapi-0.1.tar.gz]
- [TRIVA v25 http://www-id.imag.fr/Laboratoire/Membres/Schnorr_Lucas/triva/triva-25.tar.gz]
- [30012008-1320-20np-1th-2cluster-fibo-45.5 http://www-id.imag.fr/Laboratoire/Membres/Schnorr_Lucas/triva/30012008-1320-20np-1th-2cluster-fibo-45.5.tar.gz] (trace example)


= Tracing KAAPI =

In order to trace a KAAPI application, the library must be configured with
**--enable-trace** option during the compilation. The TRIVA expects at least the
svn **revision number 1799** of KAAPI library in order to operate correctly.
```
$ svn checkout svn://svn.gforge.inria.fr/svn/kaapi/trunk/ kaapi-svn
$ cd kaapi-svn
$ ./configure --enable-trace --prefix=/opt/kaapi/
$ make install
```
After KAAPI is installed in all the machines, the application must be executed
with the following parameters in order to properly generate traces.
```
$ karun ./fibo_apiatha 40 5 --util -trace.enable true
```
The user can also mask some events so they are not included in the trace file.
This is performed by entering, after the command line above, the option
**-trace.mask '3,0 3,1'**. This can repeat for other events with the following
format 'levelID,eventID'. Check **kaapi_events.h** in the KAAPI source code for
more details about each of them.

These are the events that should **NOT** be masked, ever.
|| level id | event id | needed for              |
|     1     |     6    |     timestamping        |
|     1     |     7    |     hostname            |
|     1     |     8    |     hostname bloc       |

After the application execution, a directory named **trace** will be present in
each machine that participated of the execution. Inside this directory, there
are files with filenames like rawfile.0, rawfile.1, ... There are one of these
files for each KAAPI process. If karun was executed with **--np 20**,
there will be 20 rawfiles,
possibly spreaded in 20 different machines (if 20 machines were used
to execute the application).
**These files must be collected manually and placed in the same directory.**

After having all trace files in the same place, it is necessary to individually
sort them by timestamp. For this, use the application **sorttrace** that is
distributed with the KAAPI source package. It is compiled in the
**examples/advanced/** directory of KAAPI. Taking into account that sorttrace is
in the PATH variable, 
it is possible to sort the files in a directory using the
following script:
: **Script to sort KAAPI trace files**
```
#!/bin/sh

DIR=$1

if test ! -d $DIR
then
        exit
fi
FILES=`ls -1 $DIR/rawfile.*`
for i in $FILES
do
        AUX=`echo $i | sed "s/\/\//\//"`
        NUM=`echo $AUX | cut -d'/' -f2 | cut -d. -f2`
        NEWSORTEDFILENAME="sorted$NUM.trc"
        sorttrace $AUX
        mv sorted.trc $DIR/$NEWSORTEDFILENAME
done
```


Assuming that there is a directory named kaapi-trace 
in the current directory, it is used like this:
```
./sort.sh kaapi-trace/
```

== Synchronization ==

Use **rastro_timesync** of libRastro in order to synchronize the event
 generated in different machines (with different clocks). It can be download
from [this link rastro_timesync.c], and compile it like:
```
$ gcc rastro_timesync.c -o rastro_timesync
```

The following script uses rastro_timesync in order to generate a timesync file
with synchronization information. It assumes that rastro_timesync is present in
the PATH and receives a file with hostnames, one per line. It will generate a
file named **timesync.DATE**, where DATE is just a unique identifier. This
script must be executed at least two times, one before and one after the
application execution. All the content of timesync.* files must be copied in a
single file timesync, to be used by TRIVA.

: **Script to generate timesync**
```
#!/bin/bash
if [ -z $1 ]
then
        echo "Use: $0 hostfile"
        exit
fi
DATE=`date +%s`
TIMESYNCFILENAME=timesync.$DATE
for i in `cat $1`; do X="$X $i"; done
echo "Executing..."
rastro_timesync `hostname` $X > $TIMESYNCFILENAME
```
